name: Infrastructure Drift Detection

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository to check (leave empty for all)'
        required: false
        type: string
      environment:
        description: 'Environment to check'
        required: true
        type: choice
        options:
          - staging
          - production
          - all

env:
  TF_VERSION: '1.6.0'

jobs:
  detect-drift:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Add your source repos here
        source_repo: 
          - source-monorepo
          # - source-app-repo
          # - source-infra-repo
        environment:
          - staging
          - production
      fail-fast: false
    
    # Skip if specific repo/env requested and doesn't match
    if: |
      (github.event_name == 'schedule') ||
      (inputs.source_repo == '' || inputs.source_repo == matrix.source_repo) &&
      (inputs.environment == 'all' || inputs.environment == matrix.environment)

    steps:
      - name: Checkout Manager Repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Fetch Variables from Source Repo
        id: fetch-vars
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.SOURCE_REPOS_PAT }}
          script: |
            try {
              const { data } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: '${{ matrix.source_repo }}',
                path: 'infra/variables.yml',
                ref: 'main'
              });
              
              const content = Buffer.from(data.content, 'base64').toString();
              require('fs').writeFileSync('source-variables.yml', content);
              core.info('Fetched variables from source repo');
              return true;
            } catch (error) {
              core.warning(`Could not fetch variables: ${error.message}`);
              return false;
            }

      - name: Configure AWS Credentials
        if: steps.fetch-vars.outputs.result == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Terraform Init
        if: steps.fetch-vars.outputs.result == 'true'
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ matrix.source_repo }}/${{ matrix.environment }}/terraform.tfstate" \
            -backend-config="region=us-east-1"

      - name: Check for Drift
        if: steps.fetch-vars.outputs.result == 'true'
        id: drift
        working-directory: terraform
        continue-on-error: true
        run: |
          # Move variables file
          mv ../source-variables.yml .
          
          # Run plan in detailed mode
          terraform plan \
            -var="source_repo=${{ matrix.source_repo }}" \
            -var="environment=${{ matrix.environment }}" \
            -var-file="source-variables.yml" \
            -detailed-exitcode \
            -no-color > drift-output.txt 2>&1
          
          EXIT_CODE=$?
          
          # Exit codes: 0 = no changes, 1 = error, 2 = changes detected
          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=no-drift" >> $GITHUB_OUTPUT
            echo "No drift detected"
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "status=drift-detected" >> $GITHUB_OUTPUT
            echo "Drift detected!"
            cat drift-output.txt
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "Error checking for drift"
            cat drift-output.txt
          fi
          
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Upload Drift Report
        if: steps.drift.outputs.status == 'drift-detected'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ matrix.source_repo }}-${{ matrix.environment }}
          path: terraform/drift-output.txt

      - name: Create Issue for Drift
        if: steps.drift.outputs.status == 'drift-detected'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.SOURCE_REPOS_PAT }}
          script: |
            const fs = require('fs');
            const drift = fs.readFileSync('terraform/drift-output.txt', 'utf8');
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: '${{ matrix.source_repo }}',
              state: 'open',
              labels: 'infrastructure,drift-detected',
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('${{ matrix.environment }}') &&
              issue.title.includes('Infrastructure Drift')
            );
            
            const body = `## Infrastructure Drift Detected
            
            **Environment:** \`${{ matrix.environment }}\`
            **Detected:** ${new Date().toISOString()}
            
            Infrastructure drift has been detected between the Terraform state and actual infrastructure.
            
            ### Drift Details
            
            \`\`\`terraform
            ${drift.slice(0, 60000)}
            \`\`\`
            
            ### Next Steps
            
            1. Review the drift details above
            2. Determine if this is expected or requires remediation
            3. If expected, update \`infra/variables.yml\` and merge to apply changes
            4. If unexpected, investigate what caused the drift
            
            ### Remediation
            
            To fix this drift, either:
            - Update your infrastructure code to match current state, or
            - Apply Terraform to bring infrastructure back to desired state
            
            [View drift detection workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: '${{ matrix.source_repo }}',
                issue_number: existingIssue.number,
                body: `## Drift Still Present\n\n${body}`
              });
              core.info(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: '${{ matrix.source_repo }}',
                title: `ðŸš¨ Infrastructure Drift Detected - ${{ matrix.environment }}`,
                body: body,
                labels: ['infrastructure', 'drift-detected', '${{ matrix.environment }}']
              });
              core.info('Created new drift detection issue');
            }

  summary:
    runs-on: ubuntu-latest
    needs: detect-drift
    if: always()
    steps:
      - name: Drift Detection Summary
        run: |
          echo "# Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Drift detection completed for all configured repositories." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job results for details." >> $GITHUB_STEP_SUMMARY

